<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VISOR</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
html,body,#map{height:100%;margin:0}
.pin{width:16px;height:16px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 10px rgba(0,0,0,.5)}
.badge{position:absolute;top:10px;left:10px;z-index:999;background:#fff;padding:6px 10px;border-radius:999px;font-family:system-ui}
</style>
</head>
<body>
<div id="map"></div>
<div class="badge" id="status">Esperando eventosâ€¦</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://zacogqlscfdwncugfkko.supabase.co";
const SUPABASE_KEY = "sb_publishable_5D_QVNyeqroW9tQO_jnmoA_cHS8PXE_";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const map = L.map("map").setView([40.4168,-3.7038],6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
const layer = L.layerGroup().addTo(map);

function pin(color){
  return L.divIcon({
    html: '<div class="pin" style="background:'+color+'"></div>',
    iconSize:[16,16]
  });
}

sb.channel("visor")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"visor_events"},payload=>{
    const d = payload.new;
    layer.clearLayers();
    L.marker([d.lat,d.lng],{icon:pin(d.color||"#000")}).addTo(layer);
    map.setView([d.lat,d.lng],14);
    document.getElementById("status").textContent = d.estado;
  })
  .subscribe();
</script>
</body>
</html>
