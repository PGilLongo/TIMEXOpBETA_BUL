<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NAVEGADOR</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hud {
      position: absolute; z-index: 9999;
      top: 12px; left: 12px;
      background: rgba(255,255,255,.92);
      padding: 10px 12px; border-radius: 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
    }

    .row {
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: nowrap;
      white-space: nowrap;
    }

    button { cursor:pointer; }

    .file-btn {
      display:inline-flex;
      align-items:center;
      padding: 2px 10px;
      border: 1px solid rgba(0,0,0,.25);
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
      line-height: 24px;
      white-space: nowrap;
    }

    #kmzFile { display:none; }

    .leaflet-control-layers {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      border-radius: 10px;
    }

    .follow {
      display:flex;
      align-items:center;
      gap:4px;
      white-space: nowrap;
    }
  
    .search-wrap{
      margin-top:8px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    #searchBox{
      width: 260px;
      max-width: 70vw;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,.25);
      font-size: 14px;
      outline: none;
    }
    #clearRouteBtn{
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,.25);
      background: #fff;
    }
    #results{
      margin-top:6px;
      max-height: 220px;
      overflow:auto;
      border: 1px solid rgba(0,0,0,.15);
      border-radius: 10px;
      background: rgba(255,255,255,.98);
      display:none;
    }
    .result-item{
      padding: 8px 10px;
      cursor:pointer;
      border-bottom: 1px solid rgba(0,0,0,.06);
      font-size: 14px;
    }
    .result-item:last-child{ border-bottom: none; }
    .result-item:hover{ background: rgba(0,0,0,.04); }
    .muted{ color: rgba(0,0,0,.6); font-size: 12px; }

  </style>
</head>
<body>
  <div class="hud">
    <div class="row">
      <button id="recenterBtn" type="button">Centrarme</button>
      <button id="fitAllBtn" type="button">Ver todo</button>

      <label class="follow">
        <input id="followChk" type="checkbox" checked />
        seguirme
      </label>

      <button id="chooseFilesBtn" type="button" class="file-btn">
        Elegir archivos
      </button>
    </div>

    <div class="search-wrap">
      <input id="searchBox" type="search" placeholder="Buscar punto por nombre…" autocomplete="off" />
      <button id="clearRouteBtn" type="button" title="Quitar la ruta actual">Quitar ruta</button>
      <span class="muted" id="searchHint">Carga KMZ para buscar.</span>
    </div>
    <div id="results" aria-label="Resultados de búsqueda"></div>

    <input type="file" id="kmzFile" accept=".kmz" multiple />
    <small id="status">Pidiendo ubicación…</small>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@5.6.2/dist/togeojson.umd.js"></script>

  <script>
    const statusEl = document.getElementById("status");
    const followChk = document.getElementById("followChk");
    const recenterBtn = document.getElementById("recenterBtn");
    const fitAllBtn = document.getElementById("fitAllBtn");
    const kmzInput = document.getElementById("kmzFile");
    const chooseFilesBtn = document.getElementById("chooseFilesBtn");

    // Buscador + rutas
    const searchBox = document.getElementById("searchBox");
    const resultsEl = document.getElementById("results");
    const clearRouteBtn = document.getElementById("clearRouteBtn");
    const searchHint = document.getElementById("searchHint");

    // Índice de puntos (placemarks) por nombre
    // { name, latlng, marker, kmzLabel }
    const poiIndex = [];

    // Ruta actual (Leaflet Routing Machine)
    let routingControl = null;

    function clearRoute(){
      if(routingControl){
        map.removeControl(routingControl);
        routingControl = null;
      }
    }
    clearRouteBtn.addEventListener("click", clearRoute);

    function normalize(s){
      return (s ?? "").toString().trim();
    }

    function setResultsVisible(v){
      resultsEl.style.display = v ? "block" : "none";
    }

    function renderResults(items){
      resultsEl.innerHTML = "";
      if(!items.length){
        setResultsVisible(false);
        return;
      }
      const frag = document.createDocumentFragment();
      items.slice(0, 80).forEach((it)=>{
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerHTML = `<b>${it.name || "Sin nombre"}</b><br/><span class="muted">${it.kmzLabel}</span>`;
        div.addEventListener("click", ()=>{
          setResultsVisible(false);
          searchBox.blur();

          // centrar y abrir popup si existe
          map.setView(it.latlng, Math.max(map.getZoom(), 17));
          if(it.marker && it.marker.openPopup) it.marker.openPopup();

          if(!lastLatLng){
            statusEl.textContent = "Aún no tengo tu ubicación. Activa el GPS/permiso y prueba otra vez.";
            return;
          }

          clearRoute();
          routingControl = L.Routing.control({
            waypoints: [ lastLatLng, it.latlng ],
            addWaypoints: false,
            draggableWaypoints: false,
            routeWhileDragging: false,
            show: false,
            fitSelectedRoutes: true,
            lineOptions: { addWaypoints:false }
          }).addTo(map);

          statusEl.textContent = `Ruta: tu ubicación → ${it.name || "punto seleccionado"}`;
        });
        frag.appendChild(div);
      });
      resultsEl.appendChild(frag);
      setResultsVisible(true);
    }

    function doSearch(){
      const q = normalize(searchBox.value).toLowerCase();
      if(!poiIndex.length){
        searchHint.textContent = "Carga KMZ para buscar.";
        setResultsVisible(false);
        return;
      }
      if(!q){
        searchHint.textContent = `Escribe para buscar entre ${poiIndex.length} puntos…`;
        setResultsVisible(false);
        return;
      }
      const hits = poiIndex.filter(p => (p.name || "").toLowerCase().includes(q));
      searchHint.textContent = `${hits.length} resultado(s)`;
      renderResults(hits);
    }

    searchBox.addEventListener("input", doSearch);
    searchBox.addEventListener("focus", doSearch);

    // Cierra resultados al clicar fuera
    document.addEventListener("click", (e)=>{
      const inHud = e.target.closest && e.target.closest(".hud");
      if(!inHud) setResultsVisible(false);
    });


    // Abrir selector de archivos SIN contraseña
    chooseFilesBtn.addEventListener("click", () => {
      kmzInput.click();
    });

    const map = L.map("map").setView([40.4168, -3.7038], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    const meIcon = L.divIcon({
      html: '<div style="width:14px;height:14px;border-radius:50%;background:#2b6cff;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.35)"></div>',
      iconSize:[14,14],
      iconAnchor:[7,7]
    });

    // Iconos de KMZ: sin imagen, un punto (círculo) de color distinto por cada KMZ
    // 30% más pequeño que el punto de tu ubicación (14px -> ~10px)
    function kmzColorForIndex(i){
      // colores bien separados usando el ángulo áureo
      const hue = (i * 137.508) % 360;
      return `hsl(${hue} 85% 50%)`;
    }

    function makeKmzDotIcon(color){
      const size = 10;   // ~30% menos que 14px
      const border = 2;  // borde blanco para contraste
      return L.divIcon({
        className: "",
        html: `<div style="
          width:${size}px;height:${size}px;border-radius:50%;
          background:${color};
          border:${border}px solid #fff;
          box-shadow:0 2px 10px rgba(0,0,0,.25);
        "></div>`,
        iconSize:[size, size],
        iconAnchor:[size/2, size/2]
      });
    }

    const overlays = {};
    const layersControl = L.control.layers({}, overlays, { collapsed:false }).addTo(map);
    const kmzLayersList = [];
    let kmzCounter = 1;

    let myMarker=null, myAccuracyCircle=null, lastLatLng=null, firstFix=true;

    function updateMyLocation(pos){
      const {latitude, longitude, accuracy} = pos.coords;
      lastLatLng = L.latLng(latitude, longitude);

      if(!myMarker){
        myMarker = L.marker(lastLatLng,{icon:meIcon}).addTo(map);
        myAccuracyCircle = L.circle(lastLatLng,{
          radius:accuracy,
          weight:1,
          fillOpacity:.1
        }).addTo(map);
      }else{
        myMarker.setLatLng(lastLatLng);
        myAccuracyCircle.setLatLng(lastLatLng);
        myAccuracyCircle.setRadius(accuracy);
      }

      statusEl.textContent =
        `Tu posición: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (±${Math.round(accuracy)} m)`;

      if(firstFix){
        map.setView(lastLatLng,17);
        firstFix=false;
      }else if(followChk.checked){
        map.panTo(lastLatLng, { animate:true });
      }
    }

    function geoError(err){
      statusEl.textContent = `No se pudo obtener tu ubicación: ${err.message}`;
    }

    if(navigator.geolocation){
      navigator.geolocation.watchPosition(updateMyLocation, geoError, {
        enableHighAccuracy:true,
        maximumAge:1000,
        timeout:10000
      });
    }else{
      statusEl.textContent = "Tu navegador no soporta geolocalización.";
    }

    recenterBtn.onclick = () =>
      lastLatLng && map.setView(lastLatLng, Math.max(map.getZoom(), 17));

    fitAllBtn.onclick = ()=>{
      let bounds=null;

      kmzLayersList.forEach(({layer})=>{
        if(map.hasLayer(layer)){
          const b = layer.getBounds?.();
          if(b && b.isValid && b.isValid())
            bounds = bounds ? bounds.extend(b) : b;
        }
      });

      if(lastLatLng){
        const b = L.latLngBounds([lastLatLng,lastLatLng]);
        bounds = bounds ? bounds.extend(b) : b;
      }

      bounds && bounds.isValid && bounds.isValid() &&
        map.fitBounds(bounds.pad(.2));
    };

    async function loadKmzFile(file){
      statusEl.textContent = `Leyendo ${file.name}…`;

      // Color e icono para ESTE KMZ
      const color = kmzColorForIndex(kmzCounter);
      const kmzDotIcon = makeKmzDotIcon(color);

      const zip = await JSZip.loadAsync(await file.arrayBuffer());
      const kmlName = Object.keys(zip.files)
        .find(n => n.toLowerCase().endsWith(".kml"));

      if(!kmlName) throw new Error("KMZ sin .kml interno");

      const dom = new DOMParser().parseFromString(
        await zip.files[kmlName].async("text"),
        "text/xml"
      );

      const geojson = toGeoJSON.kml(dom);

      const layer = L.geoJSON(geojson,{
        pointToLayer:(feature,ll)=>{
          const marker = L.marker(ll,{icon:kmzDotIcon});
          // Indexar solo puntos con coordenadas
          const name = feature?.properties?.name ?? "Elemento";
          poiIndex.push({ name, latlng: ll, marker, kmzLabel: file.name });
          searchHint.textContent = `Escribe para buscar entre ${poiIndex.length} puntos…`;
          return marker;
        },
        onEachFeature:(feature, lyr)=>{
          const name = feature?.properties?.name ?? "Elemento";
          const desc = feature?.properties?.description ?? "";
          lyr.bindPopup(
            desc ? `<b>${name}</b><br/>${desc}` : `<b>${name}</b>`
          );
        }
      }).addTo(map);

      const label = `${kmzCounter++}. ${file.name}`;
      overlays[label] = layer;
      layersControl.addOverlay(layer, label);
      kmzLayersList.push({layer});

      const b = layer.getBounds?.();
      if(b && b.isValid && b.isValid())
        map.fitBounds(b.pad(.2));

      statusEl.textContent = `Cargado: ${file.name}`;
    }

    kmzInput.onchange = async e=>{
      const files = Array.from(e.target.files || []);
      for(const f of files){
        try { await loadKmzFile(f); }
        catch(err){
          statusEl.textContent =
            `Error KMZ (${f.name}): ${err.message}`;
        }
      }
      kmzInput.value = "";
    };
  </script>
</body>
</html>
